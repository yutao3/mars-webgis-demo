<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Mars Web GIS Prototype</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"
      integrity="sha256-zLrzE8CbnMD4HzyBbs6k8ZZrVSu2VvulaHYodNs/WSY="
      crossorigin=""
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-measure@3.3.1/dist/leaflet-measure.css"
      integrity="sha256-9n6mfm8KbIOnZhgb71CkHyIx9/odRa0gh6+acpIwNdc="
      crossorigin=""
    />
    <style>
      :root {
        color-scheme: dark light;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        font-family: "Segoe UI", Tahoma, sans-serif;
        background: #0a0a0a;
        color: #f5f5f5;
      }

      #map {
        height: 100%;
        width: 100%;
        position: relative;
        background: #050505;
      }

      .control-panel {
        position: absolute;
        top: 12px;
        left: 12px;
        z-index: 1000;
        max-width: 320px;
        background: rgba(18, 18, 18, 0.92);
        color: #f5f5f5;
        padding: 12px 14px;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
      }

      .control-panel h1 {
        font-size: 1rem;
        margin: 0 0 6px;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .control-panel .section {
        margin-bottom: 14px;
      }

      .control-panel label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        margin-bottom: 6px;
      }

      .layer-entry {
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.04);
      }

      .layer-entry strong {
        display: block;
        font-size: 0.92rem;
        margin-bottom: 4px;
      }

      .layer-entry small {
        display: block;
        font-size: 0.75rem;
        opacity: 0.75;
        margin-bottom: 6px;
        line-height: 1.3;
      }

      .layer-status {
        font-size: 0.75rem;
        margin-left: 6px;
        color: #ffd866;
      }

      .opacity-group {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.78rem;
      }

      .opacity-group input[type="range"] {
        flex: 1;
      }

      button,
      .control-panel input[type="checkbox"] {
        cursor: pointer;
      }

      .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .actions button {
        flex: 1;
        min-width: 120px;
        border: none;
        border-radius: 6px;
        padding: 8px 10px;
        background: #ff6b35;
        color: #fff;
        font-weight: 600;
        letter-spacing: 0.03em;
        transition: background 0.2s ease;
      }

      .actions button.secondary {
        background: rgba(255, 255, 255, 0.18);
      }

      .actions button:hover {
        background: #ff854f;
      }

      .actions button.secondary:hover {
        background: rgba(255, 255, 255, 0.28);
      }

      .leaflet-container .leaflet-control-measure {
        font-family: inherit;
      }

      .leaflet-control-scale {
        font-size: 11px;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 3px;
        padding: 2px 6px;
      }

      .brand-mark {
        position: absolute;
        bottom: 12px;
        right: 12px;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        background: rgba(18, 18, 18, 0.82);
        border-radius: 999px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(6px);
        pointer-events: none;
      }

      .brand-mark img {
        display: block;
        width: 32px;
        height: 32px;
      }

      .brand-mark span {
        font-size: 0.8rem;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.8);
      }

      @media (max-width: 600px) {
        .control-panel {
          right: 12px;
          left: 12px;
          max-width: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <aside class="control-panel" aria-label="Mars GIS controls">
      <h1>Mars Web GIS</h1>
      <div class="section" id="layer-list" aria-live="polite"></div>
      <div class="section actions">
        <button id="download-png" type="button">Download PNG</button>
        <button id="clear-annotations" type="button" class="secondary">Clear Annotations</button>
      </div>
      <div class="section" style="font-size:0.72rem; opacity:0.75; line-height:1.35;">
        Tip: HRSC / CTX loads by default; enable the CaSSIS mosaic when you need extra detail. Measurement (ruler icon) and drawing tools sit on the map.
      </div>
    </aside>
    <div class="brand-mark">
      <img src="favicon.ico" alt="SAIIL logo" />
      <span>SAIIL Mars WebGIS Demo</span>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/geotiff@2.1.3/dist-browser/geotiff.min.js"></script>
    <script src="https://unpkg.com/georaster@1.7.1/dist/georaster.browserify.min.js"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet@1.8.2/dist/georaster-layer-for-leaflet.min.js"></script>
    <script
      src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"
      integrity="sha256-sb2sMSmc5QwDFi1Cdm42Hcps225y7sY9qsK0kGugK7I="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/leaflet-measure@3.3.1/dist/leaflet-measure.min.js"></script>
    <script src="https://unpkg.com/leaflet-simple-map-screenshoter@0.4.4/dist/leaflet-simple-map-screenshoter.min.js"></script>
    <script>
      const map = L.map('map', {
        crs: L.CRS.EPSG4326,
        center: [0, 0],
        zoom: 3,
        zoomControl: true,
        zoomSnap: 0.5,
        zoomDelta: 0.5,
        preferCanvas: true
      });

      const baseLayer = L.tileLayer.wms('https://planetarymaps.usgs.gov/cgi-bin/mapserv', {
        map: '/maps/mars_simp_cyl.map',
        layers: 'MDIM21',
        format: 'image/png',
        transparent: false,
        version: '1.3.0',
        attribution: 'Imagery: USGS Astrogeology (MDIM 2.1)'
      }).addTo(map);

      map.createPane('pane-hrsc');
      map.getPane('pane-hrsc').style.zIndex = 500;
      map.createPane('pane-cassis');
      map.getPane('pane-cassis').style.zIndex = 510;

      L.control.scale({ position: 'bottomleft', imperial: false, maxWidth: 150 }).addTo(map);

      const drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      const drawControl = new L.Control.Draw({
        position: 'topleft',
        draw: {
          polygon: true,
          polyline: true,
          rectangle: true,
          circle: false,
          circlemarker: false,
          marker: true
        },
        edit: {
          featureGroup: drawnItems,
          edit: true,
          remove: true
        }
      });
      map.addControl(drawControl);

      map.on(L.Draw.Event.CREATED, event => {
        drawnItems.addLayer(event.layer);
      });

      const measureControl = new L.Control.Measure({
        position: 'topleft',
        primaryLengthUnit: 'kilometers',
        secondaryLengthUnit: 'meters',
        primaryAreaUnit: 'sqkilometers',
        secondaryAreaUnit: 'hectares',
        activeColor: '#ff6b35',
        completedColor: '#3ddc97'
      });
      measureControl.addTo(map);

      const screenshoter = L.simpleMapScreenshoter({
        position: 'topleft',
        screenName: 'mars-map.png',
        hideElementsWithSelectors: [
          '.leaflet-control-container .leaflet-top.leaflet-left',
          '.leaflet-control-container .leaflet-top.leaflet-right'
        ]
      }).addTo(map);

      const overlayConfigs = [
        {
          id: 'cassis',
          name: 'CaSSIS Pan SRR Mosaic (RGB)',
          description:
            'High-resolution CaSSIS SRR mosaic (8-bit RGB). Large file; initial load may take a while.',
          url:
            'https://archives.esac.esa.int/psa/ftp/Guest-Storage-Facility/UCL-MSSL_Oxia-Planum-CaSSIS-SRR_MADNet_1.0/cassis_pan_srr_mosaic_hrsc_rgb_colour.tif',
          pane: 'pane-cassis',
          defaultVisible: false,
          resolution: 512
        },
        {
          id: 'hrsc',
          name: 'HRSC / CTX Reference Mosaic (HMC_11W24_ND5_OXIA_CROP)',
          description:
            'CTX / HRSC mosaic (single band). Recommended as contextual layer behind CaSSIS imagery.',
          url:
            'https://archives.esac.esa.int/psa/ftp/Guest-Storage-Facility/UCL-MSSL_Oxia-Planum_HRSC_CTX_HiRISE_MADNet_V1.0/HMC_11W24_ND5_OXIA_CROP.tif',
          pane: 'pane-hrsc',
          defaultVisible: true,
          resolution: 512,
          opacity: 0.85
        }
      ];

      const layerList = document.getElementById('layer-list');
      const state = new Map();

      function createColorFn(georaster, noDataValue) {
        if (georaster.numberOfRasters >= 3) {
          return values => {
            if (!values) return null;
            const [r, g, b] = values;
            if ([r, g, b].some(v => v === null || v === undefined)) return null;
            if (
              noDataValue !== undefined &&
              ([r, g, b].every(v => v === noDataValue) || r === noDataValue)
            ) {
              return null;
            }
            return `rgb(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)})`;
          };
        }

        const min = Array.isArray(georaster.mins) ? georaster.mins[0] : georaster.min;
        const max = Array.isArray(georaster.maxs) ? georaster.maxs[0] : georaster.max;
        const lo = Number.isFinite(min) ? min : 0;
        const hi = Number.isFinite(max) ? max : lo + 1;
        return values => {
          const value = values && values[0];
          if (value === null || value === undefined) return null;
          if (noDataValue !== undefined && value === noDataValue) return null;
          const t = (value - lo) / (hi - lo || 1);
          const clamped = Math.max(0, Math.min(1, t));
          const g = Math.round(clamped * 255);
          return `rgb(${g}, ${g}, ${g})`;
        };
      }

      async function ensureLayer(config, statusEl) {
        if (state.has(config.id) && state.get(config.id).layer) {
          return state.get(config.id);
        }
        if (state.has(config.id) && state.get(config.id).promise) {
          return state.get(config.id).promise;
        }

        const deferred = (async () => {
          statusEl.textContent = 'loading…';
          try {
            const response = await fetch(config.url, {
              mode: 'cors'
            });
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            const arrayBuffer = await response.arrayBuffer();
            const georaster = await parseGeoraster(arrayBuffer);
            const options = {
              georaster,
              pane: config.pane,
              resolution: config.resolution || 256,
              opacity: config.opacity ?? 1,
              updateWhenIdle: true,
              pixelValuesToColorFn: createColorFn(georaster, georaster.noDataValue),
              useWebWorkers: false
            };
            const layer = new GeoRasterLayer(options);
            layer.on('load', () => {
              statusEl.textContent = '';
            });
            const result = { layer, georaster };
            state.set(config.id, result);
            return result;
          } catch (error) {
            console.error('Failed to load GeoTIFF layer', config.name, error);
            statusEl.textContent = 'failed';
            throw error;
          }
        })();

        state.set(config.id, { promise: deferred });
        return deferred;
      }

      function fitToLayer(georaster) {
        if (!georaster) return;
        const bounds = [
          [georaster.ymin, georaster.xmin],
          [georaster.ymax, georaster.xmax]
        ];
        map.fitBounds(bounds, { padding: [20, 20] });
      }

      overlayConfigs.forEach((config, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'layer-entry';
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = Boolean(config.defaultVisible);
        checkbox.setAttribute('data-layer', config.id);
        checkbox.id = `layer-${config.id}`;
        const title = document.createElement('strong');
        title.textContent = config.name;
        const status = document.createElement('span');
        status.className = 'layer-status';
        const description = document.createElement('small');
        description.textContent = config.description;
        label.appendChild(checkbox);
        label.appendChild(title);
        label.appendChild(status);
        wrapper.appendChild(label);
        wrapper.appendChild(description);

        const opacityGroup = document.createElement('div');
        opacityGroup.className = 'opacity-group';
        const opacityLabel = document.createElement('span');
        opacityLabel.textContent = 'Opacity';
        const slider = document.createElement('input');
        slider.type = 'range';
        slider.min = '0';
        slider.max = '1';
        slider.step = '0.05';
        slider.value = String(config.opacity ?? 1);
        slider.disabled = true;
        opacityGroup.appendChild(opacityLabel);
        opacityGroup.appendChild(slider);
        wrapper.appendChild(opacityGroup);

        layerList.appendChild(wrapper);

        checkbox.addEventListener('change', async event => {
          if (event.target.checked) {
            try {
              const result = await ensureLayer(config, status);
              const { layer, georaster } = result;
              layer.addTo(map);
              slider.disabled = false;
              slider.value = String(layer.options.opacity ?? 1);
              if (!config._fitted) {
                fitToLayer(georaster);
                config._fitted = true;
              }
            } catch (error) {
              alert(
                `Unable to load ${config.name}. The remote host may be missing CORS headers or range request support. See console for details.`
              );
              checkbox.checked = false;
            } finally {
              if (status.textContent === 'loading…') {
                status.textContent = '';
              }
            }
          } else {
            slider.disabled = true;
            const info = state.get(config.id);
            if (info && info.layer && map.hasLayer(info.layer)) {
              map.removeLayer(info.layer);
            }
          }
        });

        slider.addEventListener('input', event => {
          const opacity = parseFloat(event.target.value);
          const info = state.get(config.id);
          if (info && info.layer) {
            info.layer.setOpacity(opacity);
          }
        });

        if (checkbox.checked) {
          checkbox.dispatchEvent(new Event('change'));
        }
      });

      document.getElementById('clear-annotations').addEventListener('click', () => {
        drawnItems.clearLayers();
      });

      document.getElementById('download-png').addEventListener('click', async () => {
        try {
          const blob = await screenshoter.takeScreen('blob', { mimeType: 'image/png' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
          link.download = `mars-webgis-${timestamp}.png`;
          document.body.appendChild(link);
          link.click();
          requestAnimationFrame(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          });
        } catch (error) {
          console.error('Failed to export map', error);
          alert('Export failed. Check console for details.');
        }
      });
    </script>
  </body>
</html>
