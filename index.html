<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SAIIL — Mars Web GIS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="favicon.ico" />
  <style>
    html, body { height:100%; margin:0; background:#0b0d12; }
    .frame { width:100%; height:100%; border:0; }
    noscript, .no-js { color:#e7e9ee; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding:16px; }
  </style>
</head>
<body>
  <!-- The entire app is embedded below via srcdoc so no extra files are required -->
  <iframe class="frame" title="SAIIL Mars Web GIS"
    sandbox="allow-scripts allow-same-origin allow-downloads"
    srcdoc='
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="favicon.ico" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@9.2.4/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@9.2.4/dist/ol.js"></script>
<style>
  :root{ --bg:#0b0d12; --panel:#141824; --panel2:#10131b; --border:#2a2f3d; --text:#e7e9ee; --muted:#b9bfcd; --accent:#8ea8ff; --accent-2:#5e86ff; }
  html, body { height:100%; margin:0; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); background:var(--bg); }
  .app { display:grid; grid-template-columns: 340px 1fr; grid-template-rows: 100vh; }

  .sidebar { background:linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%); border-right:1px solid var(--border); padding:14px; box-sizing:border-box; overflow:auto; }
  .brand { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
  .brand .dot { width:10px; height:10px; background:var(--accent); border-radius:50%; box-shadow: 0 0 10px var(--accent-2); }
  .brand h1 { font-size:15px; margin:0; font-weight:600; letter-spacing:0.2px; }
  .section { border:1px solid var(--border); border-radius:12px; padding:10px; margin-top:10px; background:rgba(255,255,255,0.02); }
  .section h3 { margin:0 0 8px 0; font-size:13px; font-weight:700; color:var(--text); }
  .help { font-size:12px; color:var(--muted); margin-top:6px; }
  .layers label, .basemap label { display:flex; align-items:center; gap:8px; margin:8px 0; cursor:pointer; }
  .btn-row { display:flex; flex-wrap:wrap; gap:8px; }
  button { appearance:none; border:1px solid var(--border); color:var(--text); background:#0f1320; padding:8px 10px; border-radius:10px; font-size:13px; cursor:pointer; }
  button:hover { border-color:var(--accent); }
  button.active { border-color:var(--accent); box-shadow: 0 0 0 2px rgba(142,168,255,0.18) inset; }
  .danger { border-color:#5a2a2a; background:#1a1010; }
  .danger:hover { border-color:#b55; }
  .subgrid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }

  #map { position:relative; }
  .map { width:100%; height:100%; }
  .topbar { position:absolute; left:12px; top:12px; z-index:10; pointer-events:none; display:flex; gap:8px; flex-wrap:wrap; }
  .chip { pointer-events:auto; background:rgba(0,0,0,0.35); border:1px solid var(--border); color:var(--text); padding:6px 10px; border-radius:999px; font-size:12px; }
  .error { position:absolute; right:12px; top:12px; z-index:10; pointer-events:auto; background:#2b1111; color:#ffd7d7; border:1px solid #723; padding:10px 12px; border-radius:10px; max-width:520px; display:none; }

  .br { position:absolute; right:10px; bottom:10px; z-index:10; display:flex; flex-direction:column; align-items:flex-end; gap:8px; }
  .ol-scale-line { position:static; background:rgba(20,20,28,0.9); color:#e6e6ea; border:1px solid var(--border); border-radius:8px; padding:2px 6px; }
  .logo { width:160px; height:auto; opacity:0.95; border-radius:10px; border:1px solid var(--border); background:#0f0f16; padding:6px; }

  .tooltip { position:absolute; background: rgba(20,20,28,0.9); color: #fff; padding: 4px 8px; border: 1px solid var(--border); border-radius: 6px; white-space: nowrap; pointer-events: none; transform: translate(-50%, -120%); font-size:12px; }
  .tooltip.hidden { display:none; }

  @media (max-width: 900px) {
    .app { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
    .sidebar { max-height:48vh; }
    #map { height: calc(100vh - 48vh); }
  }
</style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="dot"></div>
        <h1>SAIIL — Mars Web GIS</h1>
      </div>

      <div class="section basemap">
        <h3>Basemap (MOLA)</h3>
        <label><input type="radio" name="basemap" id="bm-color" checked> <span>MOLA Colour (XYZ)</span></label>
        <label><input type="radio" name="basemap" id="bm-hill"> <span>MOLA Hillshade (XYZ)</span></label>
        <div class="help">Global XYZ tiles (OpenPlanetary). Colour is default.</div>
      </div>

      <div class="section layers">
        <h3>Overlays (ESA GeoTIFF, lazy-loaded)</h3>
        <label><input type="checkbox" id="chk-hrsc"> <span>HRSC mosaic (HMC_11W24_ND5_OXIA_CROP.tif)</span></label>
        <label><input type="checkbox" id="chk-ctx"> <span>CTX ORI (F23_044811…_ORI.tif)</span></label>
        <div class="btn-row" style="margin-top:8px;">
          <button id="btn-zoom-hrsc">Zoom to HRSC</button>
          <button id="btn-zoom-ctx">Zoom to CTX</button>
        </div>
        <div class="help">Remote ESA hosts may block CORS. Mirror them on your domain for guaranteed display & export.</div>
      </div>

      <div class="section">
        <h3>Annotations & Measure</h3>
        <div class="btn-row" style="margin-bottom:8px;">
          <button id="btn-select" title="Select/modify features">Select</button>
          <button id="btn-point"  title="Add points">Point</button>
          <button id="btn-line"   title="Add line (measure length)">Line</button>
          <button id="btn-poly"   title="Add polygon (measure area)">Polygon</button>
        </div>
        <div class="btn-row">
          <button id="btn-clear" class="danger">Clear annotations</button>
        </div>
        <div class="help">Measurements use a Mars sphere (R ≈ 3,396,190 m). Drag vertices to refine.</div>
      </div>

      <div class="section">
        <h3>Print / Export</h3>
        <div class="subgrid">
          <button id="btn-export">Export PNG</button>
          <button id="btn-reset">Reset view</button>
        </div>
        <div class="help">Exports map, annotations, scale bar, and logo.</div>
      </div>
    </aside>

    <main id="map">
      <div id="mapCanvas" class="map"></div>
      <div class="topbar">
        <div id="globalWarn" class="chip" style="display:none;"></div>
      </div>
      <div id="err" class="error"></div>
      <div class="br">
        <div id="scaleSlot"></div>
        <img class="logo" src="SAIIL-logo-medium-size.png" alt="SAIIL logo" onerror="this.style.display=\"none\"">
      </div>
    </main>
  </div>

<script>
  // --- OpenLayers aliases
  const Map = ol.Map;
  const View = ol.View;
  const ImageLayer = ol.layer.Image;
  const TileLayer = ol.layer.Tile;
  const VectorLayer = ol.layer.Vector;
  const GeoTIFFSource = ol.source.GeoTIFF;
  const XYZ = ol.source.XYZ;
  const VectorSource = ol.source.Vector;
  const {Projection} = ol.proj;
  const {ScaleLine, defaults: defaultControls} = ol.control;
  const {Draw, Modify, Select} = ol.interaction;
  const {Style, Stroke, Fill, Circle: CircleStyle} = ol.style;
  const {LineString, Polygon} = ol.geom;
  const Overlay = ol.Overlay;
  const {getArea, getLength} = ol.sphere;

  // Mars spherical lon/lat
  const MARS_RADIUS = 3396190; // meters
  const marsProj = new Projection({ code:"MARS:4326", units:"degrees", extent:[-180,-90,180,90], global:true, worldExtent:[-180,-90,180,90] });
  ol.proj.addProjection(marsProj);

  // Basemaps (HTTPS, CORS-friendly)
  const XYZ_MOLA_COLOR = "https://s3-eu-west-1.amazonaws.com/whereonmars.cartodb.net/mola_color-noshade_global/{z}/{x}/{y}.png";
  const XYZ_MOLA_HILL  = "https://s3-eu-west-1.amazonaws.com/whereonmars.cartodb.net/mola_hillshade/{z}/{x}/{y}.png";
  const colorBase = new TileLayer({ source: new XYZ({ url: XYZ_MOLA_COLOR, crossOrigin: "anonymous" }), visible: true,  zIndex: 0 });
  const hillBase  = new TileLayer({ source: new XYZ({ url: XYZ_MOLA_HILL,  crossOrigin: "anonymous" }), visible: false, zIndex: 0 });

  // ESA GeoTIFF URLs (lazy creation)
  const URL_HRSC = "https://archives.esac.esa.int/psa/ftp/Guest-Storage-Facility/UCL-MSSL_Oxia-Planum_HRSC_CTX_HiRISE_MADNet_V1.0/HMC_11W24_ND5_OXIA_CROP.tif";
  const URL_CTX  = "https://archives.esac.esa.int/psa/ftp/Guest-Storage-Facility/UCL-MSSL_Oxia-Planum_HRSC_CTX_HiRISE_MADNet_V1.0/CTX-ORIs/F23_044811_1985_XN_18N024W-F23_044956_1984_XN_18N024W-ORI.tif";

  let hrscLayer = null;
  let ctxLayer  = null;

  function createGeoTiffLayer(url, zIndex){
    const src = new GeoTIFFSource({
      sources: [{ url }],
      convertToRGB: true,
      normalize: false,
      interpolate: true
    });
    const lyr = new ImageLayer({ source: src, visible: true, zIndex });
    src.on("change", () => {
      const st = src.getState?.();
      if (st === "error") showError("Failed to load " + url + " (likely CORS on remote host).");
    });
    return lyr;
  }

  // Annotations
  const vectorSource = new VectorSource();
  const vectorLayer = new VectorLayer({
    source: vectorSource,
    zIndex: 20,
    style: (feature) => {
      const geom = feature.getGeometry();
      const stroke = new Stroke({ color: "#9f9fff", width: 2 });
      const fill = new Fill({ color: "rgba(159,159,255,0.15)" });
      if (geom instanceof LineString) return new Style({ stroke });
      if (geom instanceof Polygon)   return new Style({ stroke, fill });
      return new Style({ image: new CircleStyle({ radius:5, fill: new Fill({color:"#9f9fff"}), stroke: new Stroke({color:"#333", width:1}) }) });
    }
  });

  // Map
  const map = new Map({
    target: "mapCanvas",
    layers: [colorBase, hillBase, vectorLayer],
    view: new View({ projection: marsProj, center:[0,0], zoom:2, minZoom:1, maxZoom:22 }),
    controls: defaultControls({ zoom: true, attribution:false })
  });

  // Scale bar
  const scale = new ScaleLine({ units:"metric", minWidth:140, bar:false, steps:4 });
  scale.setTarget(document.getElementById("scaleSlot"));
  map.addControl(scale);

  // UI helpers
  const errBox = document.getElementById("err");
  function showError(msg){ errBox.textContent = msg; errBox.style.display="block"; clearTimeout(showError._t); showError._t = setTimeout(()=>errBox.style.display="none", 9000); }

  // Warn if a global GeoTIFF.js exists INSIDE the iframe (should not)
  if (window.GeoTIFF) {
    const warn = document.getElementById("globalWarn");
    warn.style.display = "block";
    warn.textContent = "Detected global GeoTIFF.js in this iframe. Remove any <script src=.../GeoTIFF.js> — it conflicts with OpenLayers.";
  }

  // Basemap toggles
  document.getElementById("bm-color").addEventListener("change", (e)=> {
    if (e.target.checked){ colorBase.setVisible(true); hillBase.setVisible(false); }
  });
  document.getElementById("bm-hill").addEventListener("change", (e)=> {
    if (e.target.checked){ colorBase.setVisible(false); hillBase.setVisible(true); }
  });

  // Overlays (lazy load/remove)
  const chkHRSC = document.getElementById("chk-hrsc");
  const chkCTX  = document.getElementById("chk-ctx");

  chkHRSC.addEventListener("change", ()=> {
    if (chkHRSC.checked) {
      if (!hrscLayer) { hrscLayer = createGeoTiffLayer(URL_HRSC, 10); map.addLayer(hrscLayer); }
      else { hrscLayer.setVisible(true); }
    } else if (hrscLayer) { hrscLayer.setVisible(false); }
  });

  chkCTX.addEventListener("change", ()=> {
    if (chkCTX.checked) {
      if (!ctxLayer) { ctxLayer = createGeoTiffLayer(URL_CTX, 11); map.addLayer(ctxLayer); }
      else { ctxLayer.setVisible(true); }
    } else if (ctxLayer) { ctxLayer.setVisible(false); }
  });

  // Zoom to layer extent
  document.getElementById("btn-zoom-hrsc").onclick = ()=> {
    if (!hrscLayer) return showError("HRSC not loaded yet. Tick the HRSC checkbox first.");
    const ex = hrscLayer.getSource().getImageExtent?.();
    if (ex) map.getView().fit(ex, { padding:[20,20,20,20], duration:600 });
    else showError("HRSC extent not available yet. Try again in a moment.");
  };
  document.getElementById("btn-zoom-ctx").onclick = ()=> {
    if (!ctxLayer) return showError("CTX not loaded yet. Tick the CTX checkbox first.");
    const ex = ctxLayer.getSource().getImageExtent?.();
    if (ex) map.getView().fit(ex, { padding:[20,20,20,20], duration:600 });
    else showError("CTX extent not available yet. Try again in a moment.");
  };

  // Interactions
  const select = new Select();
  const modify = new Modify({ source: vectorSource });
  map.addInteraction(select);
  map.addInteraction(modify);
  let draw = null;
  function setMode(mode){
    if (draw) { map.removeInteraction(draw); draw = null; }
    ["btn-select","btn-point","btn-line","btn-poly"].forEach(id=>document.getElementById(id).classList.remove("active"));
    if (mode === "select"){
      select.setActive(true); modify.setActive(true);
      document.getElementById("btn-select").classList.add("active"); tooltip.classList.add("hidden"); return;
    }
    select.setActive(false); modify.setActive(false);
    const type = mode==="line" ? "LineString" : mode==="poly" ? "Polygon" : "Point";
    draw = new Draw({ source: vectorSource, type });
    map.addInteraction(draw);
    document.getElementById("btn-" + (mode==="poly"?"poly":mode==="line"?"line":"point")).classList.add("active");
    draw.on("drawstart", (evt)=>{ tooltip.classList.remove("hidden"); updateTooltip(evt.feature); evt.feature.on("change", ()=> updateTooltip(evt.feature)); });
    draw.on("drawend",   ()=> setTimeout(()=> tooltip.classList.add("hidden"), 200));
  }
  document.getElementById("btn-select").onclick = ()=> setMode("select");
  document.getElementById("btn-point").onclick  = ()=> setMode("point");
  document.getElementById("btn-line").onclick   = ()=> setMode("line");
  document.getElementById("btn-poly").onclick   = ()=> setMode("poly");
  document.getElementById("btn-clear").onclick  = ()=> vectorSource.clear();
  document.getElementById("btn-reset").onclick  = ()=> { map.getView().setCenter([0,0]); map.getView().setZoom(2); };
  setMode("select");

  // Measurement tooltip
  const tooltip = document.createElement("div");
  tooltip.className = "tooltip hidden";
  const tooltipOverlay = new Overlay({ element: tooltip, offset:[0, -12], positioning:"bottom-center" });
  map.addOverlay(tooltipOverlay);
  function formatLen(m){ return m>1000 ? (m/1000).toFixed(2)+" km" : m.toFixed(1)+" m"; }
  function formatArea(a){ return a>1e6 ? (a/1e6).toFixed(2)+" km²" : a.toFixed(1)+" m²"; }
  function updateTooltip(feature){
    const g = feature.getGeometry();
    if (g instanceof LineString){
      const coords = g.getCoordinates();
      const len = getLength(new LineString(coords,"XY"), {radius:MARS_RADIUS});
      tooltip.textContent = "Length: " + formatLen(len);
      tooltipOverlay.setPosition(coords[coords.length-1]);
    } else if (g instanceof Polygon){
      const ring = g.getCoordinates()[0];
      const area = getArea(new Polygon([ring],"XY"), {radius:MARS_RADIUS});
      tooltip.textContent = "Area: " + formatArea(area);
      tooltipOverlay.setPosition(ring[ring.length-2] || ring[0]);
    } else {
      const c = g.getCoordinates();
      tooltip.textContent = "Point: " + c.map(v=>v.toFixed(4)).join(", ");
      tooltipOverlay.setPosition(c);
    }
  }

  // Export PNG (layers + annotations + scale + logo)
  document.getElementById("btn-export").onclick = () => {
    try {
      const size = map.getSize(); if (!size) return;
      map.renderSync();
      const out = document.createElement("canvas"); out.width = size[0]; out.height = size[1];
      const ctx = out.getContext("2d");

      document.querySelectorAll(".ol-layer canvas").forEach(cv => {
        if (cv.width === 0 || cv.height === 0) return;
        const tr = cv.style.transform; const m = tr.match(/^matrix\\(([^(]+)\\)$/);
        if (m) { const v = m[1].split(",").map(Number); ctx.setTransform(v[0],v[1],v[2],v[3],v[4],v[5]); }
        else { ctx.setTransform(1,0,0,1,0,0); }
        ctx.globalAlpha = cv.parentNode.style.opacity ? Number(cv.parentNode.style.opacity) : 1;
        ctx.drawImage(cv, 0, 0);
      });
      ctx.setTransform(1,0,0,1,0,0);

      drawExportScaleBar(ctx);

      const logo = document.querySelector(".logo");
      if (logo && logo.complete && logo.naturalWidth > 0) {
        const margin = 10, w = Math.min(160, out.width*0.2), h = w * (logo.naturalHeight / logo.naturalWidth);
        ctx.save(); ctx.globalAlpha = 0.95; roundRect(ctx, out.width - w - margin, out.height - h - margin, w, h, 10); ctx.clip();
        ctx.drawImage(logo, out.width - w - margin, out.height - h - margin, w, h); ctx.restore();
        ctx.strokeStyle = "rgba(255,255,255,0.25)"; ctx.lineWidth = 1; roundRect(ctx, out.width - w - margin, out.height - h - margin, w, h, 10); ctx.stroke();
      }

      const url = out.toDataURL("image/png"); const a = document.createElement("a"); a.href = url; a.download = "saiil-mars-map.png"; a.click();
    } catch (e) {
      console.error(e);
      showError("Export blocked by browser due to cross-origin canvas. Ensure remote overlays are CORS-enabled.");
    }
  };

  // Export helpers
  function metersPerPixel() {
    const res = map.getView().getResolution(); if (!res) return 0;
    const c = map.getView().getCenter(); if (!c) return 0;
    const c1 = [c[0], c[1]], c2 = [c[0] + res, c[1]];
    return getLength(new LineString([c1,c2],"XY"), {radius:MARS_RADIUS});
  }
  function niceScale(max){ const p = Math.pow(10, Math.floor(Math.log10(max))); const d = max / p; if (d >= 5) return 5*p; if (d >= 2) return 2*p; return 1*p; }
  function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function drawExportScaleBar(ctx){
    const mpp = metersPerPixel(); if (!mpp) return;
    const targetPx = 180, targetMeters = targetPx * mpp, barMeters = niceScale(targetMeters), barPx = barMeters / mpp;
    const margin = 14, barH = 10; const x = ctx.canvas.width - barPx - margin; const y = ctx.canvas.height - margin - 8 - barH;
    ctx.fillStyle = "rgba(20,20,28,0.9)"; ctx.strokeStyle = "rgba(255,255,255,0.25)"; ctx.lineWidth = 1;
    roundRect(ctx, x-8, y-10, barPx+16, barH+26, 8); ctx.fill(); ctx.stroke();
    ctx.fillStyle = "#e6e6ea"; ctx.fillRect(x, y, barPx, barH);
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial"; ctx.fillStyle = "#e6e6ea";
    const label = barMeters>=1000 ? (barMeters/1000).toFixed(barMeters%1000===0?0:1)+" km" : Math.round(barMeters)+" m";
    ctx.fillText(label, x, y-4);
  }
</script>
</body>
</html>
'>
  </iframe>

  <noscript><div class="no-js">This app requires JavaScript enabled.</div></noscript>
</body>
</html>
